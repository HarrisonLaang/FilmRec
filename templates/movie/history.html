{% extends 'movie/base.html' %}
{% load static %}
{% block content %}

<script src="{% static 'layer/layer.js' %}"></script>

<style>
    .rating-history-wrap {
        padding-top: 25px;
        padding-bottom: 40px;
        color: #f9fafb;
    }

    .rating-history-header {
        margin-bottom: 20px;
    }

    .rating-history-title {
        font-size: 24px;
        font-weight: 700;
        margin: 0 0 6px;
        color: #ffffff;
    }

    .rating-history-subtitle {
        font-size: 13px;
        color: #9ca3af;
    }

    .rating-history-subtitle span {
        color: #facc15;
        font-weight: 600;
    }

    .rating-message {
        margin-bottom: 15px;
    }

    .rating-card {
        display: flex;
        align-items: flex-start;
        margin-bottom: 18px;
        padding: 16px 18px;
        border-radius: 16px;
        background: radial-gradient(circle at top left,#111827 0,#020617 60%);
        border: 1px solid rgba(148,163,184,0.3);
        box-shadow: 0 10px 24px rgba(0,0,0,0.8);
        transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }

    .rating-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 16px 30px rgba(15,23,42,0.9);
        border-color: rgba(248,250,252,0.3);
    }

    .rating-poster {
        flex-shrink: 0;
        margin-right: 16px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 18px rgba(0,0,0,0.9);
        background: #020617;
    }

    .rating-poster img {
        display: block;
        width: 130px;
        height: 190px;
        object-fit: cover;
    }

    .rating-info {
        flex: 1;
        min-width: 0;
    }

    .rating-title-row {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 6px;
    }

    .rating-movie-name {
        font-size: 18px;
        font-weight: 600;
        color: #e5e7eb;
        margin: 0;
    }

    .rating-badge {
        font-size: 12px;
        padding: 3px 10px;
        border-radius: 999px;
        background: rgba(15,118,110,0.25);
        border: 1px solid rgba(16,185,129,0.9);
        color: #a7f3d0;
        white-space: nowrap;
    }

    .rating-badge span {
        color: #34d399;
        font-weight: 600;
    }

    .rating-line {
        font-size: 13px;
        color: #d1d5db;
        margin-bottom: 6px;
    }

    .rating-line strong {
        color: #fbbf24;
        font-weight: 600;
    }

    .rating-hearts {
        font-size: 13px;
        color: #fb923c;
        margin-bottom: 6px;
    }

    .rating-comment {
        font-size: 13px;
        color: #e5e7eb;
        margin-bottom: 8px;
        word-wrap: break-word;
        word-break: break-word;
    }

    .rating-comment-label {
        color: #9ca3af;
        margin-right: 6px;
    }

    .rating-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-top: 4px;
    }

    .rating-time {
        font-size: 12px;
        color: #6b7280;
    }

    .rating-delete-btn {
        border-radius: 999px;
        padding: 4px 12px;
        font-size: 12px;
        border: 1px solid rgba(248,113,113,0.85);
        background: transparent;
        color: #fecaca;
        transition: background .15s ease, color .15s ease, border-color .15s ease;
    }

    .rating-delete-btn:hover {
        background: #ef4444;
        color: #f9fafb;
        border-color: #ef4444;
    }

    .rating-empty {
        margin-top: 30px;
        text-align: center;
        color: #9ca3af;
        font-size: 14px;
    }

    .rating-empty a {
        color: #facc15;
    }

    @media (max-width: 768px) {
        .rating-card {
            flex-direction: column;
        }

        .rating-poster {
            margin-right: 0;
            margin-bottom: 10px;
        }

        .rating-title-row {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>

<div class="container rating-history-wrap">

    {% if messages %}
        <div class="rating-message">
            {% for message in messages %}
                {% if message.tags == 'info' or message.tags == 'success' %}
                    <div class="alert alert-success" role="alert">{{ message }}</div>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}

    <!-- Header -->
    <div class="rating-history-header">
        <h1 class="rating-history-title">Rating history</h1>
        <p class="rating-history-subtitle">
            All the movies you have rated in this system.
            {% if ratings %}
                Currently <span>{{ ratings|length }}</span> entries.
            {% endif %}
        </p>
    </div>

    <!-- List -->
    {% if ratings %}
        {% for rating in ratings %}
            <div class="rating-card">
                <!-- Poster -->
                <div class="rating-poster">
                    <a href="{% url 'movie:detail' rating.movie.pk %}">
                        <img src="{% static 'movie/poster/' %}{{ rating.movie.imdb_id }}.jpg"
                             alt="{{ rating.movie.name }}">
                    </a>
                </div>

                <!-- Info -->
                <div class="rating-info">
                    <div class="rating-title-row">
                        <h3 class="rating-movie-name">{{ rating.movie.name }}</h3>
                        <div class="rating-badge">
                            Average score <span>{{ rating.movie.get_score }}</span>
                        </div>
                    </div>

                    <div class="rating-line">
                        My rating:
                        <strong>{{ rating.score }}</strong> / 5
                    </div>

                    <div class="rating-hearts">
                        {% for foo in rating.movie.get_score_int_range %}
                            ❤
                        {% endfor %}
                    </div>

                    <div class="rating-comment">
                        <span class="rating-comment-label">My review:</span>
                        {% if rating.comment %}
                            {{ rating.comment }}
                        {% else %}
                            <span style="color:#6b7280;">No review yet.</span>
                        {% endif %}
                    </div>

                    <div class="rating-footer">
                        <div class="rating-time">
                            Thanks for rating this movie.
                        </div>
                        <div>
                            <button type="button"
                                    class="rating-delete-btn"
                                    onclick="confirm_delete('{% url "movie:delete_record" rating.movie.id %}')">
                                Delete review
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p class="rating-empty">
            You have not rated any movies yet.
            <a href="{% url 'movie:index' %}">Go back to the homepage →</a>
        </p>
    {% endif %}
</div>

<script>
    function confirm_delete(url) {
        layer.open({
            title: "Confirm delete",
            content: "Do you want to delete this review?",
            yes: function (index, layero) {
                location.href = url;
            }
        });
    }

    window.onkeyup = function (ev) {
        var key = ev.keyCode || ev.which;
        if (key === 27) {
            layer.closeAll();
        }
    };
</script>

{% endblock %}
